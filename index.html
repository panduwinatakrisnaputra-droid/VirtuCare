<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VirtuCare</title>
  <style>
    html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; }
    #renderCanvas { width: 100%; height: 100%; touch-action: none; }
  </style>

  <!-- Babylon.js Core + GLTF Loader + Physics Engine -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>
  <script src="https://cdn.babylonjs.com/ammo.js"></script>

  <!-- file JS eksternal untuk fisika -->
  <script src="physics.js"></script>
  <script src="hand-vr.js"></script>
  <script src="movement.js"></script>
</head>
<body>
  <canvas id="renderCanvas"></canvas>

  <script>
    // ================================
    // Inisialisasi Engine & Canvas
    // ================================
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);

    // ================================
    // Fungsi utama: Membuat Scene
    // ================================
    const createScene = async function () {
      const scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color3(0.9, 0.9, 0.95);

      // Aktifkan sistem fisika dari file physics.js
      await enablePhysics(scene);

      // ================================
      // Buat ground (lantai dunia)
      // ================================
      const ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 100, height: 100 }, scene);
      ground.checkCollisions = true;
      ground.position.y = -0.9;

      // Tambahkan Physics Impostor agar terpengaruh fisika
      ground.physicsImpostor = new BABYLON.PhysicsImpostor(
        ground,
        BABYLON.PhysicsImpostor.BoxImpostor,
        { mass: 0, restitution: 0.9 },
        scene
      );

      // ================================
      // Cahaya dan Arah
      // ================================
      const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
      light.intensity = 0.9;

      const dirLight = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(-1, -2, -1), scene);
      dirLight.intensity = 0.6;

      // ================================
      // Kamera sebagai "Player"
      // ================================
      const camera = new BABYLON.UniversalCamera("playerCam", new BABYLON.Vector3(-15, 5, -27), scene);
      camera.attachControl(canvas, true);
      camera.speed = 0.3;                 // kecepatan gerak
      camera.angularSensibility = 4000;   // sensitivitas rotasi mouse
      camera.applyGravity = true;         // terpengaruh gravitasi
      camera.checkCollisions = true;      // bisa tabrakan dengan objek lain

      // WASD control
      camera.keysUp.push(87);    // W
      camera.keysDown.push(83);  // S
      camera.keysLeft.push(65);  // A
      camera.keysRight.push(68); // D

      // ================================
// Tambahkan Model + Collision
// ================================
BABYLON.SceneLoader.Append("assets/", "ruang_periksa.glb", scene, function () {
  console.log("âœ… Model dimuat!");

  
  // Tunggu sampai model selesai dimuat sepenuhnya
  scene.executeWhenReady(() => {
    // Loop semua mesh di scene
    scene.meshes.forEach(mesh => {
      // Abaikan ground, kamera, dan helper mesh
      if (mesh.name !== "ground" && mesh.name !== "playerCam" && mesh.name !== "__root__") {
        mesh.checkCollisions = true; // Aktifkan collision
        mesh.isPickable = true;      // Boleh diklik (optional)
      }
    });
    console.log("ðŸ§± Collision diaktifkan untuk semua mesh model ruang_periksa.glb");
  });
});


      // ================================
      // Aktifkan VR / XR Mode
      // ================================
      try {
  if (window.isSecureContext && window.navigator.xr) {
    const xr = await scene.createDefaultXRExperienceAsync({
      floorMeshes: [ground]
    });
    console.log("âœ… WebXR aktif (HTTPS)");
  } else {
    console.warn("âš ï¸ WebXR dinonaktifkan - Jalankan di HTTPS untuk mengaktifkan VR/AR");
  }
} catch (e) {
  console.warn("âŒ WebXR gagal diinisialisasi:", e);
}

// ================================
// Muat GLB dengan physics
// ================================
BABYLON.SceneLoader.ImportMesh("", "assets/", "perban.glb", scene, function (meshes) {
  const rootMesh = meshes[0]; // ambil mesh utama
  rootMesh.position = new BABYLON.Vector3(-15, 0, -25);
  rootMesh.scaling = new BABYLON.Vector3(0.05, 0.05, 0.05);

  // Pastikan semua mesh aktif
  meshes.forEach(mesh => {
    mesh.isVisible = true;
    mesh.checkCollisions = true;
  });

  // Tambahkan physics impostor
  rootMesh.physicsImpostor = new BABYLON.PhysicsImpostor(
    rootMesh,
    BABYLON.PhysicsImpostor.MeshImpostor, // bentuk mengikuti model GLB
    { mass: 2, restitution: 0.5, friction: 0.8 },
    scene
  );

  console.log("ðŸ§± Physics diterapkan pada GLB:", rootMesh.name);
});
      return scene;
    };

    // ================================
    // Jalankan Scene
    // ================================
    createScene().then(scene => {
      engine.runRenderLoop(() => scene.render());
    });

    // Resize otomatis saat jendela berubah
    window.addEventListener("resize", () => engine.resize());
  </script>
</body>
</html>
